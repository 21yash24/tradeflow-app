rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users collection rules
    match /users/{userId} {
      // Any authenticated user can read public profiles
      allow read: if isAuthenticated();
      // Only the owner can create or update their own profile
      allow create, update: if isAuthenticated() && isOwner(userId);
      
      // Rules for the 'followers' subcollection
      match /followers/{followerId} {
        // A user can only add/remove themselves as a follower
        allow create, delete: if isAuthenticated() && isOwner(followerId);
        // Any authenticated user can see who follows another user
        allow read: if isAuthenticated();
      }

      // Rules for the 'following' subcollection
      match /following/{followingId} {
         // A user can only manage their own 'following' list
        allow create, delete: if isAuthenticated() && isOwner(userId);
         // Any authenticated user can see who a user is following
        allow read: if isAuthenticated();
      }
    }
    
    // Posts collection rules
    match /posts/{postId} {
        // Any authenticated user can read posts
        allow read: if isAuthenticated();
        // A user can create a post, and only the author can update or delete it
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated() && isOwner(resource.data.authorId);
    }

    // Alerts collection rules
    match /alerts/{alertId} {
      allow read, create, update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Trades collection rules
    match /trades/{tradeId} {
       allow read, create, update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Accounts collection rules
     match /accounts/{accountId} {
       allow read, create, update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Discipline collection rules
    match /discipline/{disciplineId} {
        allow read, create, update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // Streaks collection rules
    match /streaks/{streakId} {
       allow read, create, update, delete: if isAuthenticated() && isOwner(streakId);
    }
  }
}
